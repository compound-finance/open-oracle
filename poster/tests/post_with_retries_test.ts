import {postWithRetries, signAndSend} from '../src/postWithRetries';
import Web3 from 'web3';
require('sepia');

describe('posting', () => {
  test('signs and sends', async () => {
    const provider = "http://localhost:8545";
    const web3 = await new Web3(provider);
    web3.eth.transactionConfirmationBlocks = 1;

    let senderKey = "0x7f888bbe5b812b1f8439df461d9335b30edc0f24ad65d23334e61bf107f45bb5";

    // sends the transaction
    const data = "0xa59d56ad000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020177ee777e72b8c042e05ef41d1db0f17f1fcb0e8150b37cfad6993e4373bdf1000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000006004a78a7b3013f6939da19eac6fd1ad5c5a20c41bcc5d828557442aad6f07598d029ae684620bec13e13d018cba0da5096626e83cfd4d5356d808d7437a0a5076000000000000000000000000000000000000000000000000000000000000001c";

    let receipt = await signAndSend({
      data: data,
      to: "0x4fe3dd76d873CAF6Cbf56E442B2C808D3984df1D",
      gasPrice: 10_000_000,
      gas: 100_000
    }, senderKey, web3);

    expect(receipt).toEqual(
      {
        "blockHash": "0x4dd036433dde8a2e04bf49f50f7543de20e8a66566bad42359fae6ec2a816ea3",
        "blockNumber": 1,
        "contractAddress": null,
        "cumulativeGasUsed": 29528,
        "from": "0x864f667F63B8650e10A0E52910f01198dAb19d69",
        "gas": undefined,
        "gasUsed": 29528,
        "logs": [],
        "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "nonce": undefined,
        "r": "0x13315249d203595fae8d58dfbad79460c5a24f395e7317b72409f0cb770caee6",
        "s": "0x470d1bb57af3ecbd20ac13fc22dca5f023f7cc5533a17dffd03959c8f585b545",
        "status": true,
        "to": "0x4fe3dd76d873CAF6Cbf56E442B2C808D3984df1D",
        "transactionHash": "0xc693cb5a9f8bea2fac46d003c5ebe63102704c66658b532e76a3f9a2f1272f8b",
        "transactionIndex": 0,
        "v": "0x9e"
      }
    );
  });
});
